<!-- @author yanglan -->
<!-- @email yanglan@yangqianguan.com -->
<!-- @date 2018-04-16 14:57:22.524 -->
<!-- @desc generated by yqg-cli@0.1.0-beta.8 -->

<template>

    <form :novalidate="novalidate" class="b-form" @submit.prevent="emitEvent('submit')">
        <template v-for="(fieldDef, index) in renderFieldDefs">
            <slot
                v-if="fieldDef.field"
                :name="fieldDef.field"
                :decorator="getDecorator(fieldDef)"
                :fieldDef="fieldDef">
                <b-form-group
                    :decorator="getDecorator(fieldDef)"
                    :label="fieldDef.label"
                    :key="fieldDef.field"
                    :label-key="fieldDef.labelKey"
                    :trigger="fieldDef.trigger"
                    :has-star="fieldDef.hasStar">
                    <component
                        :value="data[fieldDef.field]"
                        :is="is(fieldDef)"
                        v-bind="fieldDef.props"
                        @change="emitChange(arguments, fieldDef)"
                        @input="emitInput(arguments, fieldDef)"/>
                    <template
                        v-if="fieldDef.labelRight"
                        #labelRight
                    >
                        <component :is="fieldDef.labelRight" />
                    </template>
                </b-form-group>
            </slot>

            <br v-else-if="fieldDef.type === 'br'" :key="index">
        </template>

        <template v-if="hasBtns">
            <template v-for="(btnDef, index) in options.btnDefs">
                <button
                    v-if="btnDef.event"
                    :key="btnKey(btnDef)"
                    v-bind="btnDef.props"
                    :type="btnType(btnDef.props)"
                    class="form-button"
                    @click="emitEvent(btnDef.event)">
                    {{ btnDef.text || getText(btnDef.textKey, btnDef.textKey) }}
                </button>

                <br v-else-if="btnDef.type === 'br'" :key="index">
            </template>
        </template>

        <slot v-bind="getFormCtx()" name="actions"></slot>

        <button
            v-if="options.mainFieldCount"
            class="link"
            type="button"
            @click="changeFold">
            {{ getText('baseui.form.collapse', 'Collapse') }}
            <i :class="{'b-icon-collapse-up': !isFold, 'b-icon-collapse-down': isFold}"></i>
        </button>
    </form>

</template>

<script type="text/babel">
import BDialog from '../b-dialog';

import {FieldMap} from './constant/field';
import {isNumber} from '../../util/check';
import {getText} from '../../util/i18n';

export default {
    name: 'BForm',

    model: {
        prop: 'data',
        event: 'change'
    },

    props: {
        data: {
            type: Object,
            required: true
        },

        novalidate: {
            type: Boolean,
            default: true
        },

        options: {
            type: Object,
            default: () => { }
        },

        emitInputAsChange: {
            type: Boolean,
            default: true
        },

        defaultValidEvents: {
            type: Array,
            default: () => (['confirm', 'export'])
        },

        defaultCancelValidEvents: {
            type: Array,
            default: () => (['reset', 'cancel'])
        }
    },

    data() {
        return {
            isFold: true
        };
    },

    computed: {
        renderFieldDefs() {
            const vm = this;
            const {options: {fieldDefs, mainFieldCount}, isFold} = vm;

            return isFold && isNumber(mainFieldCount)
                ? fieldDefs.slice(0, mainFieldCount)
                : fieldDefs;
        },

        hasBtns() {
            const vm = this;

            return vm.options.btnDefs && vm.options.btnDefs.length > 0;
        },

        validEvents() {
            const {defaultValidEvents, options: {btnDefs}} = this;
            const customValidEvent = btnDefs.filter(({checkValid}) => checkValid).map(({event}) => event);
            return defaultValidEvents.concat(customValidEvent);
        },

        cancelValidEvents() {
            const {defaultCancelValidEvents, options: {btnDefs}} = this;
            const customCancelValid = btnDefs.filter(({cancelValid}) => cancelValid).map(({event}) => event);
            return defaultCancelValidEvents.concat(customCancelValid);
        },

        isInBDialog() {
            const vm = this;

            let isInDialog = false;
            const rec = ({$parent}) => {
                if (!$parent) return;

                if ($parent.$options.name === BDialog.name) {
                    isInDialog = true;
                    return;
                }

                rec($parent);
            };

            rec(vm);

            return isInDialog;
        },

        isAllValidPass() {
            return this.getAllFields().every(({hasError}) => !hasError);
        }
    },

    methods: {
        getAllFields() {
            return this.$children.filter(child => child.$options.name === 'BFormGroup');
        },

        getFields(fields) {
            return this.getAllFields().filter(({field}) => !fields || fields.includes(field));
        },

        offAllFieldsEvents() {
            this.getAllFields().forEach((child) => {
                child.offEvents();
            });
        },

        addAllFieldsEvents() {
            this.getAllFields().forEach((child) => {
                child.addEvents();
            });
        },

        resetAllFieldsValid() {
            this.getAllFields().forEach((child) => {
                child.resetValid();
            });
        },

        getField(field) {
            return this.getAllFields().find(item => field === item.field);
        },

        isFieldPass(fields) {
            return this.getFields(fields).every(({hasError}) => !hasError);
        },

        validFields(fields) {
            this.getFields(fields).forEach((child) => {
                child.valid();
            });
            return this.isFieldPass(fields);
        },

        getDecorator(fieldDef) {
            return {
                def: fieldDef,
                record: this.data,
                value: this.data[fieldDef.field]
            };
        },

        getText(key, defaultText) {
            return getText({vm: this, key, defaultText});
        },

        is({type, component}) {
            return component || FieldMap[type] || FieldMap.text;
        },

        btnType(props = {}) {
            return props.type || 'button';
        },

        btnKey({text, event}) {
            return text + event;
        },

        getFormCtx() {
            const {isInBDialog, $root, $parent} = this;
            return {
                bf: this,
                ctx: isInBDialog ? $root : $parent
            };
        },

        emitChange(data, def) {
            const {options} = this;
            const {field, type, onChange} = def;
            const emitData = {
                ...this.data,
                [field]: data[0]
            };

            if (data[0] === null || (!type && data[0] === '')) {
                delete emitData[field];
            }
            this.$emit('change', emitData, field);
            this.$nextTick(() => {
                if (onChange) {
                    const params = {
                        record: emitData,
                        value: data[0],
                        def,
                        ...this.getFormCtx(),
                        options
                    };
                    onChange(params);
                }
            });
        },

        emitInput(data, {field}) {
            const vm = this;
            const {emitInputAsChange} = vm;
            const value = data[0];

            const emitData = {
                ...vm.data,
                [field]: value
            };

            if (emitInputAsChange) {
                vm.$emit('change', emitData, field);
            } else {
                vm.$emit('input', emitData, field);
            }
        },

        emitEvent(event) {
            const {validEvents, cancelValidEvents} = this;
            if (cancelValidEvents.includes(event)) {
                this.resetAllFieldsValid();
            }
            if (validEvents.includes(event)) {
                this.validFields();
            }
            if (this.isAllValidPass) {
                this.$emit(event);
            }
        },

        changeFold() {
            this.isFold = !this.isFold;
        }
    }
};

</script>
