<!-- @author yutiangan -->
<!-- @email yutiangan@yangqianguan.com -->
<!-- @date 2018-08-09 16:29:37.108 -->
<!-- @desc generated by yqg-cli@0.2.2 -->

<template>

    <div
        class="b-date-time">
        <div class="date">
            <b-date
                :value="timeComponents.dateStartTime"
                :disabled="disabled"
                @change="handleDateChange"/>
        </div>

        <div class="time division">
            <b-select
                :value="timeComponents.hour"
                :map="HoursMap"
                :enable-reset="false"
                :disabled="disableTime"
                placeholder="HH"
                @tab="handleHourChange"
                @change="handleHourChange"/>
        </div>

        <div :class="{'division': showSecond}" class="time">
            <b-select
                :value="timeComponents.minute"
                :map="MinutesMap"
                :enable-reset="false"
                :disabled="disableTime"
                placeholder="mm"
                @tab="handleMinuteChange"
                @change="handleMinuteChange"/>
            <i
                v-if="enabledReset && !showSecond"
                :class="{'b-date-time-icon-active': !disableTime}"
                class="b-right-icon b-icon-arrow-bottom"
                @click="reset"></i>
        </div>

        <div v-if="showSecond" class="time">
            <b-select
                :value="timeComponents.second"
                :map="SecondsMap"
                :disabled="disableTime"
                placeholder="ss"
                @tab="handleSecondChange"
                @change="handleSecondChange"/>
            <i
                v-if="enabledReset"
                :class="{'b-date-time-icon-active': !disableTime}"
                class="b-right-icon b-icon-arrow-bottom"
                @click="reset"></i>
        </div>
    </div>

</template>

<script type="text/babel">
import {getTimeDigitalComponent} from '../../util/time';
import {isFunc} from '../../util/check';

import BDatePicker from '../b-date/b-date-picker.vue';
import BInput from '../b-input';

import {genMap, paddingSearchText} from './helper/helper';

const FORMAT_MAP = {
    ISO: timestamp => new Date(timestamp).toISOString()
};

export default {
    name: 'BDateTime',

    components: {
        BInput,
        BDatePicker
    },

    model: {
        prop: 'value',
        event: 'change'
    },

    props: {
        value: {
            type: [Number, String],
            validator: value => isFinite(new Date(value)),
            default: null
        },

        disabled: {
            type: Boolean,
            default: false
        },

        enabledReset: {
            type: Boolean,
            default: true
        },

        format: {
            type: [String, Function],
            default: null
        },

        showSecond: {
            type: Boolean,
            default: true
        },

        hoursMap: {
            type: Object,
            default: null
        },

        minutesMap: {
            type: Object,
            default: null
        },

        secondsMap: {
            type: Object,
            default: null
        }
    },

    data() {
        return {
            HoursMap: this.hoursMap || genMap(24),
            MinutesMap: this.minutesMap || genMap(60),
            SecondsMap: this.secondsMap || genMap(60)
        };
    },

    computed: {
        disableTime() {
            return this.disabled || this.timeComponents.dateStartTime === null;
        },

        timeComponents() {
            const {value} = this;
            if (!value) {
                return {
                    dateStartTime: null,
                    hour: null,
                    minute: null,
                    second: null
                };
            }

            const {year, month, date, hour, minute, second} = getTimeDigitalComponent(new Date(value).getTime());
            const dateStartTime = new Date(year, month - 1, date).getTime();

            return {
                dateStartTime,
                hour,
                minute,
                second
            };
        }
    },

    methods: {
        handleDateChange(dateStartTime) {
            this.handleChooseTime(dateStartTime, 'dateStartTime');
        },

        handleHourChange(searchText) {
            this.handleChooseTime(searchText, 'hour', this.HoursMap);
        },

        handleMinuteChange(searchText) {
            this.handleChooseTime(searchText, 'minute', this.MinutesMap);
        },

        handleSecondChange(searchText) {
            this.handleChooseTime(searchText, 'second', this.SecondsMap);
        },

        handleChooseTime(value, field, map) {
            const vm = this;
            const {format} = vm;
            const normalizdValue = paddingSearchText(value);
            if (map && map[normalizdValue] === undefined) return;

            const {dateStartTime, hour, minute, second} = {
                ...vm.timeComponents,
                [field]: value
            };
            const {year, month, date} = getTimeDigitalComponent(dateStartTime);

            let result = new Date(year, month - 1, date, hour, minute, second).getTime();

            if (isFunc(format)) {
                result = format(result);
            } else if (isFunc(FORMAT_MAP[format])) {
                result = FORMAT_MAP[format](result);
            }
            vm.$emit('change', result);
        },

        reset() {
            const vm = this;
            const {disableTime} = vm;
            if (!disableTime) {
                this.$emit('change', null);
            }
        }
    }
};

</script>
