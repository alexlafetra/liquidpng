
<template>
    <div class="b-transfer-panel">
        <b-card>
            <p class="b-transfer-panel__header">
                {{ title }}
                <span>{{ checkedSummary }}</span>
            </p>
            <div class="b-transfer-panel__body">
                <b-input
                    v-if="filterable"
                    v-model="query"
                    :placeholder="placeholder"
                    class="b-transfer-panel__filter">
                    <i
                        slot="right"
                        class="b-icon-reset"
                        @click="clearQuery"
                    ></i>
                </b-input>
                <b-button v-if="isQueryMethod" theme="primary" @click="handleClick">查询</b-button>
                <VNodes :vnodes="panelList()"/>
            </div>
        </b-card>

    </div>
</template>

<script type="text/babel">
import {remove} from '../../util/array';

export default {
    name: 'BTransferPanel',

    components: {
        VNodes: {
            functional: true,
            render: (ce, ctx) => ctx.props.vnodes
        }
    },

    props: {
        title: {
            type: String,
            default: ''
        },

        data: {
            type: Array,
            default: () => ([])
        },

        filterMethod: {
            type: Function,
            default: null
        },

        isQueryMethod: {
            type: Boolean,
            default: false
        },

        labelKey: {
            type: String,
            default: 'field'
        },

        placeholder: {
            type: String,
            default: ''
        },

        filterable: {
            type: Boolean,
            default: false
        },

        isAllSelected: {
            type: Boolean,
            default: false
        },

        itemHeight: {
            type: Number,
            default: 30
        },
        renderCount: {
            type: Number,
            default: 8
        },
        position: {
            type: String,
            default: 'left'
        }

    },

    data() {

        return {
            query: '',
            selected: []
        };
    },

    computed: {
        checkedSummary() {
            const vm = this;
            const {data, selected} = vm;
            return `${selected.length}/${data.length}`;
        },

        filteredData() {
            const vm = this;
            const {data, filterMethod, query, labelKey, isQueryMethod} = vm;
            if (isQueryMethod) return data;

            return data.filter((item) => {
                if (typeof filterMethod === 'function') {
                    return filterMethod(query, item);
                }
                const label = item[labelKey].toString();
                return label.toLowerCase().indexOf(query.toLowerCase()) > -1;

            });
        },

        listHeight() {
            const vm = this;
            const {itemHeight} = vm;
            return `${(vm.renderCount * itemHeight)}px`;
        }
    },

    watch: {
        data() {
            const vm = this;
            const {selected, data} = vm;
            if (!data.some(item => selected.includes(item))) {
                vm.selected = [];
            }
        }
    },

    mounted() {
        const vm = this;
        const {isAllSelected, data} = vm;
        if (isAllSelected) {
            vm.selected.push(...data);
            vm.$emit('selected-change', null, vm.selected);
        }
    },

    inject: ['bTransfer'],

    methods: {
        handleClick() {
            const vm = this;
            const {query} = vm;
            vm.$emit('search', query);
        },

        clearQuery() {
            this.query = '';
        },

        handleChoose(item, batch = null) {
            const vm = this;
            const {selected} = vm;
            if (Array.isArray(batch)) {
                vm.selected = batch;
            }
            if (selected.includes(item)) {
                remove(selected, item);
            } else {
                selected.push(item);
            }
            vm.$emit('selected-change', item, vm.selected);
        },
        chooseAll() {},

        isSelected(item) {
            const vm = this;
            const {selected} = vm;
            return selected.includes(item);
        },

        renderCommonList() {
            const vm = this;
            const {listHeight, filteredData, handleChoose, labelKey} = vm;
            const list = filteredData.map((item) => {
                const isSelected = vm.isSelected(item);
                return (
                    <li class={isSelected ? 'b-transfer-list-selected' : ''} onClick={() => handleChoose(item)}>
                        <span>{item[labelKey]}</span>
                        <i class="b-icon-tick"></i>
                    </li>
                );
            });
            return (
                <ul class="b-transfer-panel__list" style={{maxHeight: listHeight}} >
                    {list.length > 0 ? list : (
                        <li class="empty-list-item">暂无数据</li>
                    )}
                </ul>
            );
        },

        panelList() {
            const vm = this;
            const {filteredData, handleChoose, position} = vm;
            const render = vm.bTransfer.$scopedSlots.panelList;
            if (!render) {
                return vm.renderCommonList();
            }
            return render({filteredData, handleChoose, position});
        }
    }
};
</script>
