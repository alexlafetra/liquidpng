<template>
    <div class="b-pagination">
        <div v-if="size === SIZE_TYPE.NORMAL" class="size-normal">
            <button
                :class="{disabled: pageInfo.previousDisabled}"
                type="button"
                @click="previous">
                {{ getText('previous', '上一页') }}
            </button>

            <span v-for="({value, type}, index) in pageNoList" :key="index">
                <button
                    :class="{active: value === pagination.pageNo}"
                    type="button"
                    @click="changePageNo(value, type)">{{ value }}</button>
            </span>

            <button
                :class="{disabled: pageInfo.nextDisabled}"
                type="button"
                @click="next">
                {{ getText('next', '下一页') }}
            </button>
            <span v-if="isFiniteMode" class="page-jump">
                {{ getText('goto', '前往') }}
                <b-input
                    v-model="currentNo"
                    type="number"
                    @change="changePage"/>
                {{ getText('page', '页') }}
            </span>
            <span class="page-size">
                <b-select
                    :value="stringPageSize"
                    :map="pageSizeMap"
                    :enable-reset="false"
                    @change="onPageSizeChange"/>
                {{ getText('linePerPage', '行每页') }}
            </span>

            <span v-if="mode===MODE_TYPE.FINITE" class="page-info">
                {{ pageInfo.start }} - {{ pageInfo.end }} {{ getText('line', '行') }}，
                {{ getText('total', '共') }} {{ pageInfo.total }} {{ getText('line', '行') }}
            </span>
        </div>

        <div :class="{active: size === SIZE_TYPE.SMALL}" class="size-mini" b-pagination-size-normal>
            <button :class="{disabled: pageInfo.previousDisabled}" type="button" @click="previous">
                {{ getText('previous', '上一页') }}
            </button>

            <span class="page-info">
                <span class="page-current">{{ pagination.pageNo }}</span>
                / {{ totalPageNo }}
            </span>

            <button :class="{disabled: pageInfo.nextDisabled}" type="button" @click="next">
                {{ getText('next', '下一页') }}
            </button>
        </div>
    </div>
</template>

<script type="text/babel">

import {getText} from '../../util/i18n';
import BSelect from '../b-select';

const EventTypes = {
    ON_CHANGE: 'on-change'
};

const genList = (start, end) => {
    if (!start || !end || end < start) return [];

    const length = (end - start) + 1;
    return [...Array(length).keys()].map(num => ({value: num + start}));
};

const PAGE_NO_OFFSET = 1;
const MIN_BOUNDARY = 2 + (2 * PAGE_NO_OFFSET);
const WHOLE_DISPLAY_NUM = 3 + (2 * PAGE_NO_OFFSET);
const SKIP_SYMBOL = '...';
const DEFAULT_PAGE_SIZE_LIST = [10, 20, 50, 100, 200];
const PAGE_TYPE = {
    LEFT: 'LEFT',
    RIGHT: 'RIGHT',
    FRONT_RIGHT: 'FRONT_RIGHT',
    TAIL_LEFT: 'TAIL_LEFT'
};
const SIZE_TYPE = {
    NORMAL: 'normal',
    SMALL: 'sm'
};
const MODE_TYPE = {
    INFINITE: 'infinite',
    FINITE: 'finite'
};
const genPaginationWithOffset = ({pageNo, pageSize, total}) => ({
    pageNo,
    pageSize,
    total,
    offset: (pageNo - 1) * pageSize
});

export default {
    name: 'BPagination',

    components: {
        BSelect
    },

    model: {
        prop: 'pagination',
        event: EventTypes.ON_CHANGE
    },

    props: {
        pagination: {
            type: Object,
            required: true,
            validator: (value) => {
                if (typeof value != typeof {}) return false;

                return value.pageNo && value.pageSize && (value.total !== undefined);
            }
        },

        defaultPageSizeList: {
            type: Array,
            default: () => []
        },

        size: {
            type: String,
            default: SIZE_TYPE.NORMAL
        },

        mode: {
            type: String,
            default: MODE_TYPE.FINITE
        }
    },

    data() {
        return {
            SIZE_TYPE,
            MODE_TYPE,
            currentNo: this.pagination.pageNo,
            demo: '262'
        };
    },

    computed: {
        isFiniteMode() {
            return this.mode === MODE_TYPE.FINITE;
        },

        pageNoList() {
            const vm = this;
            const {pagination: {pageNo}, totalPageNo, isFiniteMode} = vm;
            // when can not get exact total
            if (totalPageNo === 0 || totalPageNo === -1) {
                return [{value: pageNo}];
            }
            // When total page num is not greater than whole display boundary
            if (totalPageNo <= WHOLE_DISPLAY_NUM + 1) {
                return genList(1, totalPageNo);
            }

            // When total page num is greater than whole display boundary
            // Front side
            if (pageNo <= MIN_BOUNDARY) {
                return [
                    ...genList(1, MIN_BOUNDARY + 1),
                    {value: SKIP_SYMBOL, type: PAGE_TYPE.FRONT_RIGHT},
                    ...(isFiniteMode ? [{value: totalPageNo}] : [])
                ];
            }

            // Tail side
            if (pageNo >= totalPageNo - 1 - PAGE_NO_OFFSET) {
                return [
                    {value: 1},
                    {value: SKIP_SYMBOL, type: PAGE_TYPE.TAIL_LEFT},
                    ...genList(totalPageNo - MIN_BOUNDARY, totalPageNo)
                ];
            }

            // Center side
            return [
                {value: 1},
                {value: SKIP_SYMBOL, type: PAGE_TYPE.LEFT},
                ...genList(pageNo - PAGE_NO_OFFSET, pageNo + PAGE_NO_OFFSET),
                {value: SKIP_SYMBOL, type: PAGE_TYPE.RIGHT},
                ...(isFiniteMode ? [{value: totalPageNo}] : [])
            ];
        },

        totalPageNo() {
            const vm = this;
            const {pagination: {pageSize, total}, isFiniteMode} = vm;
            if (!isFiniteMode && total <= 0) {
                return total;
            }
            return Math.ceil(total / pageSize) || 1;

        },

        pageSizeMap() {
            const vm = this;
            const {defaultPageSizeList} = vm;
            const pageSizeList = defaultPageSizeList.length ? defaultPageSizeList : DEFAULT_PAGE_SIZE_LIST;

            return pageSizeList.reduce((acc, cur) => {
                acc[cur] = cur.toString();
                return acc;
            }, {});
        },

        pageInfo() {
            const vm = this;
            const {pagination: {pageNo, pageSize, total}, totalPageNo, isFiniteMode} = vm;
            if (!isFiniteMode && totalPageNo <= 0) {
                return {
                    previousDisabled: pageNo <= 1,
                    nextDisabled: !!total
                };
            }
            return {
                start: ((pageNo - 1) * pageSize) + 1,
                end: Math.min(pageNo * pageSize, total),
                total,
                previousDisabled: pageNo <= 1,
                nextDisabled: pageNo >= totalPageNo
            };
        },

        stringPageSize() {
            return `${this.pagination.pageSize}`;
        }
    },

    watch: {
        'pagination.pageNo': function (newValue) {
            this.currentNo = Number(newValue);
        }
    },

    methods: {
        getText(key, defaultText) {
            return getText({vm: this, key: `baseui.pagination.${key}`, defaultText});
        },

        previous() {
            const vm = this;
            const {pagination: {pageNo}} = vm;

            if (pageNo <= 1) return;

            vm.$emit(EventTypes.ON_CHANGE, genPaginationWithOffset({
                ...vm.pagination,
                pageNo: pageNo - 1
            }));
        },

        next() {
            const vm = this;
            const {pagination: {pageNo}, totalPageNo} = vm;

            if (totalPageNo === 0) {
                vm.$emit(EventTypes.ON_CHANGE, genPaginationWithOffset({
                    ...vm.pagination,
                    pageNo: pageNo + 1
                }));
            }

            if (pageNo >= totalPageNo) return;

            vm.$emit(EventTypes.ON_CHANGE, genPaginationWithOffset({
                ...vm.pagination,
                pageNo: pageNo + 1
            }));
        },

        onPageSizeChange(pageSize) {
            const vm = this;
            const {pagination} = vm;
            if (pagination.pageSize === +pageSize) return;

            vm.$emit(EventTypes.ON_CHANGE, genPaginationWithOffset({
                ...vm.pagination,
                pageNo: 1,
                pageSize: +pageSize
            }));
        },

        changePage(value) {
            const vm = this;
            const {totalPageNo} = vm;
            let targetPage = Number(value);

            if (!Number.isInteger(targetPage)) {
                targetPage = Math.round(targetPage);
            }

            if (targetPage <= 0) {
                vm.currentNo = 1;
                vm.$emit(EventTypes.ON_CHANGE, genPaginationWithOffset({
                    ...vm.pagination,
                    pageNo: 1
                }));
                return;
            }

            if (targetPage >= totalPageNo && totalPageNo !== 0) {
                targetPage = totalPageNo;
            }
            vm.currentNo = targetPage;
            vm.$emit(EventTypes.ON_CHANGE, genPaginationWithOffset({
                ...vm.pagination,
                pageNo: targetPage
            }));
        },

        changePageNo(targetPageNo, type) {
            const vm = this;
            const {pagination: {pageNo}, totalPageNo} = vm;

            if (targetPageNo === pageNo) return;

            // Handle for skip symbol
            const SKIP_SYMBOL_JUMP_MAP = {
                [PAGE_TYPE.FRONT_RIGHT]: MIN_BOUNDARY + 2,
                [PAGE_TYPE.TAIL_LEFT]: totalPageNo - MIN_BOUNDARY - 1,
                [PAGE_TYPE.LEFT]: pageNo - PAGE_NO_OFFSET - 1,
                [PAGE_TYPE.RIGHT]: pageNo + PAGE_NO_OFFSET + 1
            };

            vm.$emit(EventTypes.ON_CHANGE, genPaginationWithOffset({
                ...vm.pagination,
                pageNo: targetPageNo === SKIP_SYMBOL ? SKIP_SYMBOL_JUMP_MAP[type] : targetPageNo
            }));
        }
    }
};

</script>
