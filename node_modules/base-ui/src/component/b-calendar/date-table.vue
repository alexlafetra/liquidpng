<!-- @author mengpeng -->
<!-- @email pengmeng@yangqianguan.com -->
<!-- @date 2019-07-25 16:24:16.302 -->
<!-- @desc generated by yqg-cli@1.0.9 -->

<template>
    <table class="b-calendar-table">
        <thead >
            <th v-for="(i,k) in daysOfWeek" :key="k">{{ i }}</th>
        </thead>
        <tbody>
            <tr v-for="(dateRow, rowIndex) in dateRowList" :key="`data-table-row-${rowIndex}`">
                <td v-for="(dateItem, itemIndex) in dateRow" :key="`data-table-cell-${itemIndex}`">
                    <div
                        :class="{
                            'view-month': dateItem.viewMonthFlag,
                            'current-date': dateItem.currentDateFlag,
                            'selected-date': dateItem.selectedDateFlag
                        }"
                        class="dateCell"
                        @click="onSelectDate(dateItem)">
                        <VNodes :vnodes="dateCell(dateItem)"/>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</template>

<script>
import {DayTypeList, getTimeDigitalComponent, DailyMillisecond} from '../../util/time';
import {getText} from '../../util/i18n';

const MonthDatesNum = 6 * 7; // Default 6 rows to cover all cases of date distribution in one month
const {year: curYear, month: curMonth, date: curDate} = getTimeDigitalComponent(Date.now());

export default {
    name: 'DataTable',

    components: {
        VNodes: {
            functional: true,
            render: (ce, ctx) => ctx.props.vnodes
        }
    },

    props: {
        firstDayOfWeek: {
            type: Number,
            default: 0
        },

        timestamp: {
            type: Number,
            default: Date.now()
        }
    },

    inject: ['bCalendar'],

    data() {
        const vm = this;
        const {timestamp} = vm;
        const initTimestamp = (timestamp || timestamp === 0) ? timestamp : Date.now();
        const {year, month, date} = getTimeDigitalComponent(initTimestamp);
        return {
            DayTypeList: vm.getText('dayTypeList', DayTypeList),
            year: year || curYear,
            month: month || curMonth,
            viewYear: year || curYear,
            viewMonth: month || curMonth,
            date
        };
    },

    computed: {
        daysOfWeek() {
            const vm = this;
            const {firstDayOfWeek: day} = vm;
            return vm.DayTypeList
            .map((_, index, arr) => (day + index > 6 ? arr[day + index - 7] : arr[day + index]));
        },
        dateRowList() {
            const vm = this;
            const {
                viewYear,
                viewMonth,
                year: selectedYear,
                month: selectedMonth,
                date: selectedDate
            } = vm;

            // get first date in this month
            const monthFirstDate = new Date(viewYear, viewMonth - 1, 1);
            const monthFirstDateTime = monthFirstDate.getTime();
            const monthFirstDay = monthFirstDate.getDay();

            // get first date in this panel
            const firstDateTime
                = monthFirstDay === 0
                    ? monthFirstDateTime
                    : monthFirstDateTime - (monthFirstDay * DailyMillisecond);

            return [...Array(MonthDatesNum).keys()]
                .map((i) => { // get a panel date object array
                    const timestamp = firstDateTime + (i * DailyMillisecond);
                    const {
                        year,
                        month,
                        date,
                        day
                    } = getTimeDigitalComponent(timestamp);

                    const viewMonthFlag = month === viewMonth;
                    const selectedDateFlag
                        = year === selectedYear
                        && month === selectedMonth
                        && date === selectedDate;
                    const currentDateFlag = year === curYear && month === curMonth && date === curDate;

                    return {
                        timestamp,
                        month,
                        date,
                        day,
                        viewMonthFlag,
                        selectedDateFlag,
                        currentDateFlag,
                        i
                    };
                })
                .reduce((acc, cur, i) => { // split panel array into rows
                    const rowNum = Math.floor(i / DayTypeList.length);

                    if (!acc[rowNum]) acc[rowNum] = [];

                    acc[rowNum].push(cur);
                    return acc;
                }, []);
        }
    },

    watch: {
        timestamp(newValue) {
            const vm = this;
            const {year, month, date} = getTimeDigitalComponent(newValue);
            vm.viewYear = year;
            vm.viewMonth = month;
            vm.year = year;
            vm.month = month;
            vm.date = date;
        }
    },

    methods: {
        getText(key, defaultText) {
            return getText({vm: this, key: `baseui.date.${key}`, defaultText});
        },

        onSelectDate(val) {
            this.$emit('on-select-date', val);
        },

        dateCell(dateItem) {
            const render = this.bCalendar.$scopedSlots.dateCell;
            if (!render) {
                return <div>{dateItem.date}</div>;
            }
            return render({...dateItem});
        }
    }
};
</script>
